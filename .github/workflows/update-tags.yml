name: Update tags
on:
  workflow_dispatch:
    inputs:
      semver:
        required: true
      branch:
        required: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@ee0669bd1cc54295c223e0bb666b733df41de1c5 # v2
      - uses: actions/setup-go@bfdd3570ce990073878bf10f6b2d79082de49492 # v2
        with:
          go-version: "^1.19"

      # generate update
      - name: Pin tags to ${{ github.event.inputs.semver }}
        run: tools/update-docker-tags.sh "${{ github.event.inputs.semver }}"
      - name: Open pull request
        uses: peter-evans/create-pull-request@18f7dc018cc2cd597073088f7c7591b9d1c02672 # v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ github.event.inputs.branch }}
          branch: upgrade-${{ github.event.inputs.branch }}
          title: "Upgrade ${{ github.event.inputs.branch }} to ${{ github.event.inputs.semver }}"
          body: |
            Upgrade the `${{ github.event.inputs.branch }}` branch's Sourcegraph Docker images to enforce constraints `${{ github.event.inputs.semver }}`.

            This pull request was generate by [this run](https://github.com/sourcegraph/deploy-sourcegraph/actions/runs/${{ github.run_id }})
          commit-message: "Upgrade to Sourcegraph ${{ github.event.inputs.semver }}"
